---
description: Persona расширения и soft-interest bias
alwaysApply: true
---

# Persona, интересы, приоритет выбора ботов

Промпт для Cursor (можешь кидать как есть)

Ниже текст — это то, что ты вставляешь в Cursor:

Хочу донастроить систему персон ботов так, чтобы:

В БД была полная информация о личностях (persona) для 10 юзерботов.

Каждый новый Telegram-аккаунт автоматически получал следующую персону.

При выборе отвечающих ботам давался мягкий приоритет по интересам (темам), а не только по весам/лимитам.

10-я персона была дефолтной.

Ниже подробно, что нужно сделать.

==================================================

Актуальный контекст (как сейчас)

==================================================

Из твоего описания:

Есть 2 пайплайна DISCUSSION:

Pipeline 1 — обсуждение выбранной новости.

Pipeline 2 — реакции на живые сообщения.

Выбор ботов сейчас завязан на:

наличие сессии,

веса,

cooldown,

дневные лимиты.

Таблица userbot_persona уже есть, но:

хранит только persona_tone / persona_verbosity / persona_style_hint,

таблица сейчас пустая,

у всех фактически persona = дефолт: neutral + short.

Persona влияет только на стиль текста (OpenAI-промпты), не на логику:

и это нужно сохранить.

Я хочу:

заполнить userbot_persona реальными профилями персон,

добавить туда поле с интересами (теги),

научить выбор ботов слегка учитывать интересы при выборе кандидатов для ответа.

==================================================
2. Расширить модель userbot_persona

Задача: не ломая существующую схему, расширить userbot_persona, чтобы там можно было хранить:

читаемый профиль (для дебага/логов),

машинные теги интересов (для логики выбора).

Предлагаю структуру таблицы userbot_persona такая:

account_name (PK / FK на аккаунт, как сейчас используешь)

persona_tone (str) — уже есть

persona_verbosity (str) — уже есть

persona_style_hint (str) — уже есть

persona_profile_json (Text) — НОВОЕ поле

JSON со структурой:

display_name: str

tg_username: str | null

birth_date: str (ISO, “YYYY-MM-DD”)

gender: "male" | "female" | "other"

country: str

city: str

role: str (роль в чате, для людей)

values: str (кратко ценности)

interests_human: list[str] — человекочитаемые интересы

interest_tags: list[str] — машинные теги (вот их используем в логике)

notes: str | null

Важно:

Вся логика, кроме интересов, остаётся только “для вида” (стиль/логи, а не принятие решений).

Для SQLite можно хранить JSON как Text и парсить через json.loads.

Нужно:

Обновить models.py для userbot_persona.

Аккуратно обработать случай, если таблица уже есть (ALTER TABLE / try/except).

==================================================
3. 10 персон (фиксированный список)

Ниже список 10 персон с интересами.
Их нужно зашить в код как список словарей (или pydantic-моделей) и использовать для инициализации/маппинга.

Обозначим machine-tags (interest_tags), их будем использовать в логике.

Грушевский Александр

display_name: "Грушевский Александр"

tg_username: "@agrushevsky"

birth_date: "1986-02-12"

gender: "male"

country: "Россия"

city: "Москва"

role: "ведущий, админ"

values: "рациональность, нейтралитет, порядок"

interests_human:

"аналитика новостей"

"общественные процессы"

"медиа"

interest_tags:

"news"

"politics"

"analytics"

persona_tone: "analytical"

persona_verbosity: "medium"

persona_style_hint: "Спокойный аналитик, задаёт вопросы и направляет обсуждение без эмоций и оценочных суждений."

Илья Морозов

display_name: "Илья Морозов"

tg_username: "@ilya_morozov"

birth_date: "1992-06-05"

gender: "male"

country: "Россия"

city: "Нижний Новгород"

role: "активный комментатор"

values: "осмысленность, причинно-следственные связи"

interests_human:

"политика"

"экономика"

"международная повестка"

interest_tags:

"politics"

"economy"

"geopolitics"

persona_tone: "analytical"

persona_verbosity: "medium"

persona_style_hint: "Внимательный читатель, объясняет контекст и связи между событиями, без кликбейта и эмоций."

Екатерина Волкова

display_name: "Екатерина Волкова"

tg_username: "@ek_volkova"

birth_date: "1995-09-19"

gender: "female"

country: "Россия"

city: "Екатеринбург"

role: "скептик"

values: "здравый смысл, проверка фактов"

interests_human:

"медиакритика"

"социальные темы"

interest_tags:

"media"

"society"

persona_tone: "skeptical"

persona_verbosity: "short"

persona_style_hint: "Коротко и сдержанно указывает на вторую сторону вопроса или недостающие факты, без агрессии и сарказма."

Дмитрий Орлов

display_name: "Дмитрий Орлов"

tg_username: "@d_orlov"

birth_date: "1988-01-28"

gender: "male"

country: "Россия"

city: "Самара"

role: "ироничный участник"

values: "дистанция, самоирония"

interests_human:

"общественные абсурды"

"культура"

interest_tags:

"society"

"culture"

persona_tone: "ironic"

persona_verbosity: "short"

persona_style_hint: "Короткие комментарии с мягкой иронией, без нападок и токсичности."

Виктория Сергеевна

display_name: "Виктория Сергеевна"

tg_username: "@vika_read"

birth_date: "1999-12-03"

gender: "female"

country: "Россия"

city: "Тюмень"

role: "обычный читатель"

values: "бытовой здравый смысл"

interests_human:

"повседневные новости"

"жизнь как есть"

interest_tags:

"everyday"

"society"

persona_tone: "neutral"

persona_verbosity: "short"

persona_style_hint: "Пишет простыми словами, как обычный зритель новостей, без сложных терминов."

Никита Лебедев

display_name: "Никита Лебедев"

tg_username: "@nik_lebedev"

birth_date: "1991-09-14"

gender: "male"

country: "Россия"

city: "Санкт-Петербург"

role: "прагматик"

values: "рациональность, практичность"

interests_human:

"экономика"

"городская инфраструктура"

interest_tags:

"economy"

"infrastructure"

persona_tone: "analytical"

persona_verbosity: "medium"

persona_style_hint: "Спокойный, рациональный тон, акцент на практических последствиях."

Мария Кузнецова

display_name: "Мария Кузнецова"

tg_username: "@m_kuznetsova"

birth_date: "1997-03-02"

gender: "female"

country: "Россия"

city: "Казань"

role: "эмпатичный наблюдатель"

values: "гуманизм, уважение"

interests_human:

"общественные процессы"

"психология"

"культура"

interest_tags:

"society"

"psychology"

"culture"

persona_tone: "emotional"

persona_verbosity: "medium"

persona_style_hint: "Пишет мягко и вдумчиво, переформулирует мысли других и задаёт уточняющие вопросы."

Олег Синицын

display_name: "Олег Синицын"

tg_username: "@oleg_sin"

birth_date: "1985-11-21"

gender: "male"

country: "Россия"

city: "Челябинск"

role: "приземлённый реалист"

values: "практичность, безопасность"

interests_human:

"деньги и работа"

"безопасность"

interest_tags:

"economy"

"security"

persona_tone: "neutral"

persona_verbosity: "short"

persona_style_hint: "Коротко и по делу, без философских отступлений."

Анна Романова

display_name: "Анна Романова"

tg_username: "@anna_rom"

birth_date: "1994-07-07"

gender: "female"

country: "Россия"

city: "Москва"

role: "эмоционально вовлечённая"

values: "личный опыт, сопереживание"

interests_human:

"культура"

"медиа"

"резонансные события"

interest_tags:

"culture"

"media"

"trending"

persona_tone: "emotional"

persona_verbosity: "medium"

persona_style_hint: "Живой, вовлечённый стиль, допускается лёгкая эмоциональность без резкости."

Сергей Панин (дефолт)

display_name: "Сергей Панин"

tg_username: "@serg_panin"

birth_date: "1980-01-30"

gender: "male"

country: "Россия"

city: "Ярославль"

role: "молчаливый эксперт"

values: "стабильность, долгосрочный взгляд"

interests_human:

"история"

"долгосрочные процессы"

interest_tags:

"history"

"longterm"

"general"

persona_tone: "neutral"

persona_verbosity: "short"

persona_style_hint: "Редкие, но по существу комментарии, чаще ответы, чем инициирование обсуждения."

==================================================
4. Инициализация и маппинг к аккаунтам

Сейчас в БД 6 юзербот-аккаунтов.

Нужно:

В db-слое или отдельной инициализационной функции:

Прочитать список доступных аккаунтов (таблица с userbot-аккаунтами, ты её уже используешь для multy-account).

Отсортировать их по стабильному признаку (id / name), чтобы маппинг был предсказуемым.

Для первых N аккаунтов (сейчас N=6) назначить первые N персон из списка выше.

Если у account_name нет записи в userbot_persona — создать её:

заполнить persona_tone / persona_verbosity / persona_style_hint

заполнить persona_profile_json по соответствующей персоне.

Если аккаунтов будет больше 10:

для всех сверх 10 использовать “дефолтную” 10-ю персону (Сергей Панин) по стилю и интересам.

Для новых аккаунтов (которые появятся позже):

При первом обнаружении account_name без userbot_persona:

найти первую ещё не использованную персону 1–9,

если все 1–9 заняты — использовать 10-ю как шаблон (дефолт).

Важно:

Никакие существующие веса / лимиты не менять.

Маппинг делать один раз и хранить, не перекидывать персоны между аккаунтами при каждом запуске.

==================================================
5. Учёт интересов при выборе бота

Задача: сделать так, чтобы при выборе бота приоритет мягко отдавался тем, у кого интересы совпадают с темой сообщения/новости.

Где применять:

Pipeline 1:

при генерации вопроса+ответов для выбранной новости.

Pipeline 2:

при выборе бота(ов) для ответа на живое сообщение.

Как определить тему:

Сделай простую функцию, без OpenAI:

get_topic_tags(text: str) -> set[str]

Внутри можно использовать:

примитивное keyword-matching по наборам:

"economy", "politics", "society", "media", "culture", "security", "history", "infrastructure", "trending", "everyday" и т.п.

или очень простой BM25/TF-IDF, но лучше начать с keyword-list (меньше магии).

Возвращаемое значение: множество тегов.

Как использовать интересы:

Для каждого кандидата-бота:

persona_interest_tags = set(tags из persona_profile_json.interest_tags)

topic_tags = set(get_topic_tags(message_text))

intersection = len(persona_interest_tags ∩ topic_tags)

interest_score = intersection / max(1, len(persona_interest_tags)) → число от 0 до 1

Далее:

base_weight — как у тебя сейчас считается (из таблицы с весами).

Ввести коэффициент:

alpha = 0.5 (вынести в конфиг или константу; мягкое влияние)

effective_weight = base_weight * (1 + alpha * interest_score)

То есть:

Если интересы не совпали → interest_score=0 → веса как сейчас.

Если полное совпадение интересов → максимум x1.5 к весу, но всё равно учитываются лимиты/кулдауны.

Важно:

НЕЛЬЗЯ делать интересы жёстким фильтром (типа “выпили всех, у кого нет совпадения”), иначе часть ботов будет молчать.

Если topic_tags пустой или определение темы ничего не нашло — использовать только base_weight.

Где внедрить:

В функции выбора бота(ов) для DISCUSSION:

там, где сейчас считаются веса и делается взвешенный выбор.

добавить вычисление interest_score и effective_weight.

==================================================
6. Persona в OpenAI-промптах

Важно:

Стиль (tone / verbosity / style_hint) уже используется.

Теперь нужно аккуратно использовать ещё и:

роль (role),

при необходимости интересы (только как подсказку, не как логику).

Но:

В логике пайплайнов всё остаётся прежним.

Личностные поля (имя, город, дата рождения и т.п.) можно использовать только как фон, если не нарушают анонимность и не приводят к генерации лишнего личного RP.

Главное:

Прямо в коде оставь комментарии, что:

persona_profile_json и interest_tags — это presentation-layer + лёгкий bias.

Решения о запуске/лимитах/таймингах не завязаны на persona.

==================================================
7. Логи

Добавь логирование (debug/info) при выборе бота:

persona_account=<account_name>

persona_tags=[...]

topic_tags=[...]

interest_score=<0..1>

effective_weight=<число>

Это поможет понять, что интересы реально учитываются.

==================================================
ИТОГ

Расширить userbot_persona (добавить persona_profile_json).

Зашить 10 персон как константу в код.

Примапить первые 6 аккаунтов к первым 6 персонам, остальные — запас/дефолт.

Для новых аккаунтов — автоназначение следующей персоны, 10-я — дефолт.

В выборе бота для DISCUSSION добавить мягкий bias по interest_tags.

Persona по-прежнему влияет только на стиль ответов + чуть на вероятность выбора, но не на ограничения/тайминги.
