---
description: Persona topics and soft selection bias
alwaysApply: true
---

# Persona topics soft-bias

ПРОМПТ ДЛЯ CURSOR

Нужно доработать систему persona для userbot’ов: добавить «интересы» (тематики), чтобы при выборе отвечающих ботов приоритет отдавался тем, кому тема ближе. Важно: не ломать существующую архитектуру DISCUSSION-пайплайнов и не добавлять новых вызовов OpenAI.

0. Контекст (как сейчас)

Уже есть:

Таблица userbot_persona с полями:

account_name

persona_tone

persona_verbosity

persona_style_hint

Persona сейчас используется только в промптах OpenAI для:

Pipeline 1 (обсуждение выбранной новости),

Pipeline 2 (ответы на живые сообщения).

Выбор ботов, веса, лимиты и cooldown на persona не завязаны.

Пайплайны DISCUSSION:

Pipeline 1: раз в интервал берёт новость из post_history, выбирает одну с помощью OpenAI, генерирует вопрос + 1–3 ответов, планирует их в discussion_replies.

Pipeline 2: периодически сканирует новые сообщения в чате, выбирает кандидата и иногда отвечает (1–2 ответа) в зависимости от окон активности, тишины, лимитов и вероятности.

Сидинг userbot_persona уже реализован в project_root/db.py:

идемпотентный,

фиксирует первые 9 персон по account_name (с нестандартными стилями),

10-я и далее — дефолт: tone=neutral, verbosity=short, style_hint=NULL.

Сейчас таблица persona уже заполняется, но интересов (тем) нет.

1. Цель доработки

Добавить к persona «интересы» по темам и использовать их в выборе ботов для DISCUSSION-пайплайнов:

у каждого userbot’а появляются 1–3 основных темы, на которые он «откликается» охотнее;

при выборе ботов для Pipeline 1/2 их базовый вес усиливается при совпадении темы поста/сообщения с интересами бота;

при этом:

все существующие лимиты/кулдауны/окна активности/вероятности остаются,

общая логика пайплайнов не меняется,

не добавляем новые вызовы OpenAI, только локальную классификацию по ключевым словам.

2. Изменения в БД (userbot_persona)

В project_root/models.py / userbot_persona:

Добавить поля (nullable, с дефолтами):

persona_topics: Mapped[Optional[str]] = mapped_column(nullable=True)
# JSON-строка: ["спорт", "крипта", "кино", ...] — короткие теги тем

persona_offtopic_tolerance: Mapped[int] = mapped_column(default=50)
# 0–100, насколько бот готов отвечать на неинтересные темы (0 = почти никогда, 100 = почти без разницы)

persona_topic_priority: Mapped[int] = mapped_column(default=50)
# 0–100, насколько сильно надо усиливать вес при совпадении темы

В миграции/инициализации:

новые поля должны получать дефолты для уже существующих записей (NULL или значения по умолчанию, чтобы не ломать запуск).

3. Классификация тем без OpenAI

Добавить модуль/функцию для определения тем по тексту без OpenAI.

Предлагаемый вариант:

В project_root/utils.py (или новый модуль topics.py) реализовать:

TOPIC_KEYWORDS: dict[str, list[str]] = {
    "спорт": ["матч", "турнир", "гол", "лига", "чемпионат", "футбол", "теннис", "хоккей"],
    "крипта": ["bitcoin", "биткоин", "крипта", "altcoin", "токен", "биржа", "бинанс"],
    "рынки": ["акции", "облигации", "индекс", "фондовый рынок", "биржа", "S&P", "NASDAQ"],
    "кино": ["фильм", "кино", "премьера", "кинопрокат", "режиссёр", "актёр", "сериал"],
    "техно": ["стартап", "ИИ", "нейросеть", "искусственный интеллект", "IT", "разработка", "инфраструктура"],
    "соцповестка": ["общество", "соцсети", "образование", "медицина", "социальный", "права"],
    "игры": ["игра", "шутер", "MMO", "стрим", "стример", "гейм", "esports", "киберспорт"],
    # можно добавить ещё 2–3 базовые темы
}

Функция:

def extract_topics_for_text(text: str, max_topics: int = 3) -> list[str]:
    """Возвращает список тем (ключей из TOPIC_KEYWORDS), по которым есть совпадения."""

Простой алгоритм достаточно:

привести текст к lower;

посчитать количество вхождений ключевых слов по темам;

вернуть темы, у которых счётчик > 0, отсортированные по убыванию счётчика;

ограничить max_topics.

Важно:

Функция не должна вызывать OpenAI;

Должна быть устойчивой к пустому/короткому тексту (возвращать []).

4. Использование интересов в выборе ботов

Нужно аккуратно встроить интересы в существующую логику выбора ботов для DISCUSSION:

Файлы: project_root/scheduler.py (или где сейчас выбираются userbot’ы) и, при необходимости, вспомогательные функции в db.py / utils.py.

4.1. Общая идея

При формировании списка кандидатов-ботов (после фильтров по:

доступным аккаунтам,

cooldown,

дневным лимитам
и т.п.):

Определяем темы текущего сообщения:

Для Pipeline 1:

используем текст выбранной новости (тот же, что отдаём в OpenAI).

Для Pipeline 2:

используем текст исходного сообщения пользователя (на которое отвечаем).

→ message_topics = extract_topics_for_text(text).

Для каждого бота:

грузим его userbot_persona (если ещё не загружено),

парсим persona_topics (если не пусто) в list[str].

Считаем topic_score:

Предложенная формула (можно вынести в отдельную функцию):

base_weight = bot_weight  # как есть сейчас

# topics_match = пересечение message_topics и persona_topics (по строкам)
if not persona_topics:
    topic_multiplier = 1.0  # generalist
else:
    if topics_match:
        # усиливаем вес: от persona_topic_priority (0–100)
        boost = 0.5 + persona_topic_priority / 100.0  # 0.5–1.5
        topic_multiplier = 1.0 + boost  # итог 1.5–2.5
    else:
        # если тема не интересна — ослабляем вес согласно offtopic_tolerance
        # 0 = почти всегда мимо, 100 = почти как обычно
        penalty = (100 - persona_offtopic_tolerance) / 100.0  # 0–1
        topic_multiplier = 1.0 - 0.5 * penalty  # от ~0.5 до 1.0
effective_weight = max(base_weight * topic_multiplier, 0.0)

Дальше используем effective_weight вместо старого веса при случайном выборе ботов по весам, не меняя остальную логику.

При этом:

если message_topics == [] → не меняем веса (коэффициент 1.0);

если у бота нет persona или поля пустые → используем дефолты (topics=[], offtopic_tolerance=50, topic_priority=50).

4.2. Где именно трогать код

Найти функции, которые сейчас делают выбор ботов:

для Pipeline 1 (кто задаёт вопрос и кто отвечает),

для Pipeline 2 (кто отвечает на живое сообщение).

Аккуратно внедрить вычисление message_topics и effective_weight в том месте, где уже сейчас происходит взвешенный выбор.

Добавить в лог:

discussion_topic_detected с:

pipeline_id,

chat_id,

message_id (если есть),

topics=[...].

discussion_bot_selection с:

pipeline_id,

chat_id,

bot_account_name,

base_weight,

effective_weight,

topics_match=True/False,

persona_topics=[...].

5. Сидинг интересов для первых 9 персон

В project_root/db.py, в том же месте, где сейчас сидится userbot_persona, нужно добавить значения persona_topics, persona_offtopic_tolerance, persona_topic_priority для первых девяти userbot’ов (по account_name, как уже делается сейчас).

Предлагаемое соответствие (по алфавиту account_name, но семантика такая):

Александр Грушевский (ведущий, админ канала)

persona_topics: ["новости", "политика", "экономика", "медиа"]

persona_offtopic_tolerance: 70 (может комментировать что угодно)

persona_topic_priority: 60

Илья Морозов (активный комментатор, tech/крипта)

persona_topics: ["техно", "крипта", "рынки"]

persona_offtopic_tolerance: 60

persona_topic_priority: 70

Екатерина Волкова (соцповестка, общество)

persona_topics: ["соцповестка", "образование", "медиа"]

persona_offtopic_tolerance: 70

persona_topic_priority: 65

Дмитрий Орлов (экономика/рынки)

persona_topics: ["рынки", "экономика", "крипта"]

persona_offtopic_tolerance: 50

persona_topic_priority: 80

Виктория Сергеевна (психология/образование)

persona_topics: ["соцповестка", "образование"]

persona_offtopic_tolerance: 80

persona_topic_priority: 60

Кирилл Сафронов (жёсткий экономический взгляд)

persona_topics: ["рынки", "экономика", "крипта"]

persona_offtopic_tolerance: 30 # почти только по делу

persona_topic_priority: 85

Алина Лебедева (кино/сериалы/стриминги)

persona_topics: ["кино", "медиа"]

persona_offtopic_tolerance: 70

persona_topic_priority: 75

Сергей Фомин (техно+безопасность/армия)

persona_topics: ["техно", "безопасность", "армия"] # можно использовать "техно" + что-то своё

persona_offtopic_tolerance: 40

persona_topic_priority: 80

Мария Ковалёва (соцтема, HR, психология)

persona_topics: ["соцповестка", "образование", "медиа"]

persona_offtopic_tolerance: 80

persona_topic_priority: 65

Тимур Алиев (дефолтный generalist, игры/киберспорт/мемы, но логически оставляем как «дефолт»)

В сидере оставить как сейчас:

persona_tone = neutral

persona_verbosity = short

persona_style_hint = NULL

persona_topics = NULL (generalist)

persona_offtopic_tolerance = 100

persona_topic_priority = 50

Важно:

сидер должен быть идемпотентным:

если у persona уже заданы persona_topics/offtopic_tolerance/topic_priority, не трогать;

заполнять только там, где NULL/дефолт.

6. Ограничения и важные моменты

Не добавлять новых OpenAI-вызовов. Темы должны определяться только локально через extract_topics_for_text.

Не трогать структуру пайплайнов (Pipeline 1/2), кроме:

пересчёта веса ботов с учётом тем;

дополнительного логирования.

Если message_topics пустой или userbot_persona не найден — возвращаться к старому поведению (использовать базовые веса как есть).

Все новые поля/функции сопровождать короткими комментариями, поясняющими идею (как сейчас сделано для discussion-пайплайнов).
