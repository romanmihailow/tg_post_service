# Промпт для изменения профиля юзербота (расширенный)

Расширенная инструкция для AI: **просмотр** и **изменение** не только персоны (характера), но и «профиля юзербота» — по данным, которые **реально есть в БД и моделях проекта**. При запросах вида *«возьми расширенный промпт и покажи профиль юзербота X»* или *«измени отображаемое имя юзербота X на Y»* — открыть этот файл и действовать по нему.

**Отличие от базовой инструкции:** поддержка двух режимов (только чтение / изменение по запросу), явная проверка схемы БД, разделение «профиль» и «персона», расширенный формат отчёта.

---

## 1. Режимы работы

### 1.1. Read-only (только просмотр)

- Пользователь просит **показать** профиль и/или персону юзербота (например: «покажи профиль юзербота t9174803110», «выведи текущее состояние персоны X»).
- Действия: найти юзербота по идентификатору, прочитать из БД **все доступные** данные (профиль, если есть в схеме, и персона), вывести отчёт в формате ниже. **Ничего не изменять.**

### 1.2. Режим изменения (только при явном запросе)

- Пользователь явно просит **изменить** одно или несколько полей (например: «измени отображаемое имя на …», «измени характер по описанию …»).
- Действия: прочитать текущее состояние, показать «Было», применить только запрошенные изменения, показать «Стало», зафиксировать в отчёте, какие поля не менялись.

---

## 2. Определение схемы: что есть в БД

Перед чтением или изменением **обязательно** проверить:

1. Открыть **`project_root/models.py`** и найти все модели, связанные с юзерботами (например `UserbotPersona` и, при наличии, таблицу профиля / дополнительные поля).
2. Таблица **`userbot_persona`** (модель `UserbotPersona`) — всегда учитывается. В ней хранятся поля персоны:
   - `account_name`, `persona_tone`, `persona_verbosity`, `persona_style_hint`, `persona_topics`, `persona_topic_priority`, `persona_offtopic_tolerance`
3. **Профиль юзербота:** если в проекте есть отдельная таблица или дополнительные колонки для отображаемого имени (ФИО / display name), даты рождения, города/страны, описания профиля или других пользовательских метаданных — они относятся к «профилю» и выводятся/изменяются только если **реально присутствуют в моделях и БД**.

**Правило:** Выводить и изменять только те поля и таблицы, которые **есть в текущей схеме**. Не предполагать наличие полей «на будущее».

---

## 3. Входные данные

### Обязательное

- **Идентификатор юзербота:** `account_name` (например `t9174800805`, `acc1`) или человекочитаемое имя, если в проекте есть однозначное соответствие с `account_name`.

### В зависимости от запроса

- **Только просмотр:** достаточно идентификатора.
- **Изменение персоны:** текст описания характера и/или явные указания по tone, verbosity, интересам (как в базовой инструкции).
- **Изменение профиля:** пользователь явно указывает, что менять (например «отображаемое имя на …», «город на …»). Изменяются **только** запрошенные поля профиля; персона не трогается.

### Если пользователь запрашивает поле, которого нет в БД

- **Явно написать:** *«Поля &lt;название&gt; нет в текущей схеме БД (таблицы userbot_persona и имеющиеся модели профиля). Изменений не вносил.»*
- Не додумывать, не создавать колонок и таблиц автоматически.

---

## 4. Поиск нужного юзербота

1. Искать запись по полю `account_name` в таблице `userbot_persona` (и при наличии — в таблице/полях профиля). В коде: `project_root/db.py`, `get_userbot_persona(session, account_name)` и при наличии — соответствующие функции для профиля.
2. Если дан **account_name** — искать по нему.
3. Если дано **человекочитаемое имя** и в проекте есть маппинг «имя → account_name» — использовать его.
4. **Если однозначно сопоставить нельзя** — задать уточняющий вопрос и **не вносить изменений**, пока не будет указан точный `account_name`.

---

## 5. Чтение текущего состояния (БД)

1. По выбранному `account_name` прочитать:
   - запись из `userbot_persona` (все поля персоны);
   - при наличии в схеме — данные профиля (отображаемое имя, дата рождения, город/страна, описание и т.п.).
2. Сохранить все прочитанные значения для отчёта «Было» (и при изменении — «Стало»).

### Если записи в userbot_persona нет

- Написать: *«Юзербот с таким account_name не найден»*.
- **Не создавать** запись автоматически, пока пользователь явно не попросит создать новую запись для этого юзербота.

---

## 6. Персона: маппинг и обновление

Правила маппинга текста описания характера в поля персоны — как в **базовой инструкции** (`промпт для изменения характера любого юзербота.md`):

- **persona_style_hint** — текст описания характера (при необходимости слегка отформатировать).
- **persona_tone** — по смыслу или явной подсказке: analytical / skeptical / ironic / emotional / neutral.
- **persona_verbosity** — short / medium по смыслу или явной подсказке.
- **persona_topics** — только если пользователь явно перечислил темы; хранить как JSON-список строк; иначе не менять.
- **persona_topic_priority** / **persona_offtopic_tolerance** — не трогать без явного запроса.

При **изменении только персоны** поля профиля (если они есть в БД) **не трогать**.

---

## 7. Профиль: обновление (если есть в БД)

- Менять только те поля профиля, которые пользователь **явно запросил** (например «измени отображаемое имя на …»).
- Если в текущей схеме нет запрошенного поля (display name, дата рождения, город, описание и т.д.) — ответить, что такого поля нет, и не вносить изменений.
- При **изменении только профиля** поля персоны (`userbot_persona`) **не трогать**.

---

## 8. ВЕРСИОНИРОВАНИЕ и разделение областей

1. **Перед любым изменением** всегда показывать текущее значение («Было»), затем новое («Стало») для затронутых полей.
2. **Изменение только профиля** — обновляются только поля профиля; **персона не трогается**.
3. **Изменение только персоны** — обновляются только поля в `userbot_persona`; **профиль не трогается**.
4. Если пользователь в одном запросе просит изменить и профиль, и персону — выполнить оба типа изменений, но в отчёте явно разделить блоки «Профиль» и «Персона» и указать, что было изменено в каждом.

---

## 9. Обновление БД

1. Формировать новые значения только для запрошенных полей (профиль и/или персона).
2. Не менять `account_name`.
3. Не менять поля, которые пользователь не просил менять (в т.ч. persona_topics, persona_topic_priority, persona_offtopic_tolerance — без явного запроса).
4. Если новые значения совпадают с текущими — не выполнять UPDATE, в ответе указать: *«Данные уже соответствуют запросу, изменений не вносил»*.
5. При реальных изменениях — UPDATE через ORM (или существующие хелперы в `project_root/db.py`), затем commit.

---

## 10. Формат отчёта

Всегда выводить структурированный отчёт.

### 10.1. Краткая строка

- При просмотре: *«Профиль и персона для account_name = &lt;имя&gt;»* (или только персона, если профиля в БД нет).
- При изменении: *«Обновлён профиль / персона / профиль и персона для account_name = &lt;имя&gt;»* или *«Изменений не вносил (данные уже соответствуют запросу)»*.

### 10.2. Блок «Профиль юзербота (если есть в БД)»

- Если в схеме есть таблица/поля профиля — вывести их в этом блоке (отображаемое имя, дата рождения, город/страна, описание и т.д.).
- При просмотре: текущие значения.
- При изменении: подблоки «Было» и «Стало» только для полей профиля; остальные поля профиля явно пометить «без изменений», если не менялись.
- Если в схеме **нет** данных профиля — написать: *«В текущей схеме БД отдельного профиля юзербота (display name, город и т.п.) нет. Учитывается только таблица userbot_persona.»*

### 10.3. Блок «Персона»

- persona_tone, persona_verbosity, persona_style_hint, persona_topics, persona_topic_priority, persona_offtopic_tolerance.
- При просмотре: текущие значения.
- При изменении: «Было» и «Стало» для изменённых полей; для неизменённых — явно указать: *«persona_… оставлены без изменений»* (перечислить поля).

### 10.4. Явное указание неизменённых полей

- В конце отчёта перечислить, какие поля/блоки сознательно не менялись (например: *«persona_topics, persona_topic_priority, persona_offtopic_tolerance оставлены без изменений»*; *«Профиль не менялся»*; *«Персона не менялась»*).

---

## 11. Безопасные ограничения

1. **Не менять схему БД:** не добавлять и не удалять таблицы, не добавлять и не удалять колонки.
2. **Не добавлять новые таблицы** без прямого запроса пользователя.
3. **Не трогать:** логику пайплайнов (Pipeline 1 / Pipeline 2), настройки OpenAI, системный промпт.
4. **Один юзербот за один запрос:** все действия только по одному `account_name`.
5. **При неоднозначности** (неясный идентификатор, неизвестное поле, противоречивый запрос): задать уточняющий вопрос и **не вносить изменений**, пока не получена ясность.
6. Не создавать новые записи (например в `userbot_persona`) без явной просьбы пользователя.

---

## 12. Ссылка на базовую инструкцию

Детальные правила маппинга описания характера в поля персоны (persona_tone, persona_verbosity, persona_style_hint, persona_topics и т.д.) и поведение по умолчанию описаны в базовой инструкции:  
**`инструкции/промпт для изменения характера любого юзербота.md`**.  
При изменении персоны руководствоваться ею в части полей таблицы `userbot_persona`.
