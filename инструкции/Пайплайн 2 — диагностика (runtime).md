# Пайплайн 2 — диагностика (runtime)

**Дата диагностики:** по состоянию БД и кода на момент анализа.  
**Ограничение:** только чтение БД, логов и кода; изменений не вносилось.

---

## Краткое резюме

Pipeline 2 для DISCUSSION-пайплайна `discuss_news_blackbox` (id=3) **включён и настроен**: `target_chat=@news_backstage` задан, `chat_state` для этого чата есть, сервис видел сообщения пользователей (`last_human_message_at` заполнен), ответы **планируются** — в `discussion_replies` есть записи с `kind='user_reply'`. При этом **все найденные записи (6 штук) имеют статус `cancelled` с причиной `message too old`**. То есть молчание связано не с отсутствием кандидатов или блокировкой на этапе планирования, а с отменой уже запланированных ответов в момент отправки: к тому времени исходное сообщение пользователя оказывается старше `user_reply_max_age_minutes` (30 минут). Логов в каталоге `logs/` не обнаружено, поэтому вывод опирается на данные БД и код.

---

## 1. DISCUSSION-пайплайн и настройки

### 1.1. Активный DISCUSSION-пайплайн

Запрос к БД:

```sql
SELECT id, name, pipeline_type, is_enabled, account_name FROM pipelines;
```

**Результат:**

| id | name                  | pipeline_type | is_enabled | account_name |
|----|------------------------|---------------|------------|--------------|
| 1  | @news_blackbox        | STANDARD      | 1          | acc1         |
| 2  | @epicenter_sport      | STANDARD      | 1          | acc1         |
| 3  | discuss_news_blackbox| DISCUSSION    | 1          | acc1         |

**Используемый DISCUSSION-пайплайн:**

- **id:** 3  
- **name:** `discuss_news_blackbox`  
- **Тип:** DISCUSSION  
- **Включён:** да (`is_enabled = 1`)  
- **Аккаунт:** `acc1`

### 1.2. Настройки дискуссии (discussion_settings)

Запрос:

```sql
SELECT pipeline_id, source_pipeline_name, target_chat,
       user_reply_max_age_minutes, max_auto_replies_per_chat_per_day,
       inactivity_pause_minutes, activity_timezone,
       activity_windows_weekdays_json, activity_windows_weekends_json
FROM discussion_settings;
```

**Результат (pipeline_id=3):**

| Поле | Значение |
|------|----------|
| pipeline_id | 3 |
| source_pipeline_name | @news_blackbox |
| target_chat | @news_backstage |
| user_reply_max_age_minutes | 30 |
| max_auto_replies_per_chat_per_day | 30 |
| inactivity_pause_minutes | 0 |
| activity_timezone | Europe/Moscow |
| activity_windows_weekdays_json | *(NULL)* |
| activity_windows_weekends_json | *(NULL)* |

**Вывод:**

- **target_chat** заполнен корректно: `@news_backstage`. Это чат, в котором сканируются сообщения и куда должны уходить живые ответы.
- Окна активности не заданы (NULL) — в коде это трактуется как «разрешено всегда» (`_is_within_windows` при пустом списке возвращает True).
- **inactivity_pause_minutes = 0** — проверка «молчания чата» по времени последнего сообщения человека не выполняется (не блокирует планирование и отправку).
- Сами по себе эти настройки **не объясняют** отсутствие ответов в чате; ограничение в 30 минут на возраст сообщения при отправке, напротив, оказывается ключевым (см. раздел 3.3 и итог).

---

## 2. Кодовая логика Pipeline 2 (в привязке к текущему состоянию)

Ниже — сжатое описание того, как **текущий** код ведёт себя при имеющихся настройках (один DISCUSSION, target_chat=@news_backstage, окна пустые, inactivity=0).

- **Запуск:** В главном цикле `run_service` (`scheduler.py`) после обработки STANDARD-пайплайнов формируется список DISCUSSION-пайплайнов с `is_enabled=1`. Для каждого вызывается `_process_live_replies_pipeline(config, accounts, account, session, pipeline)`. Для пайплайна 3 используется аккаунт `acc1`.

- **Решение «сканировать ли сейчас»:** Берётся `chat_state` для `(pipeline_id=3, chat_id=@news_backstage)`. Если `now < chat_state.next_scan_at`, сканирование не выполняется (только отправка due-ответов). Иначе — вызов `_scan_chat_for_candidates` и затем для каждого кандидата `_plan_user_reply_for_candidate`. После скана выставляется `chat_state.next_scan_at = now + random(30, 60)` сек.

- **Кандидаты:** `_scan_chat_for_candidates` запрашивает у Telegram сообщения с `min_id=last_seen_message_id`, limit=50. В кандидаты попадают сообщения не от ботов, не служебные, с текстом/медиа; дополнительно фильтр `_is_candidate_for_reply`: либо есть «?», либо одна из фраз («как думаете», «что скажете», «есть инфа», «а это как работает»), либо сообщение — ответ на нашего бота.

- **Проверки в _plan_user_reply_for_candidate:** лимит ответов за день по чату (с учётом `reply_factor`), случайная вероятность (0.4–0.6 или 0.8 при бусте), возраст сообщения &lt; user_reply_max_age_minutes (30), при inactivity_pause &gt; 0 — давность последнего человеческого сообщения, наличие доступных юзерботов (веса, daily_limit, cooldown). При текущих настройках (inactivity=0) проверка «неактивный чат» не срабатывает.

- **Создание записей user_reply:** В `_plan_user_reply_for_candidate` после успешного вызова `generate_user_reply` для каждого выбранного бота вызывается `create_discussion_reply(..., kind="user_reply", chat_id=..., reply_to_message_id=candidate["message_id"], source_message_at=base_time)`. Время отправки: первый бот — `base_time + random(2, 10)` мин, второй — плюс ещё `random(3, 15)` мин.

- **Отправка и отмена:** В начале каждого захода в `_process_live_replies_pipeline` вызывается `_send_due_user_replies`. Выбираются записи `discussion_replies` с `kind='user_reply'`, `status='pending'`, `send_at <= now`. Для каждой выполняется проверка возраста **исходного сообщения**: `age = (now - source_message_at).total_seconds() / 60`. Если `age > user_reply_max_age_minutes` (30), запись отменяется с причиной `"message too old"` (`scheduler.py`, строки 1819–1836). Отправка в Telegram выполняется только если эта проверка и остальные (аккаунт, cooldown/лимиты и т.д.) пройдены.

Таким образом, при текущих настройках логика **до создания записей и до момента отправки** не блокирует Pipeline 2; блокировка происходит **на этапе отправки** из-за ограничения по возрасту сообщения.

---

## 3. Анализ таблиц (runtime)

### 3.1. discussion_settings (runtime)

Фактические значения для pipeline_id=3 уже приведены в разделе 1.2.

**Окна активности:** JSON для будней и выходных — NULL. В коде (`_parse_activity_windows`, `_is_within_windows`) пустой список означает отсутствие ограничений по времени суток, т.е. **ограничения по окнам нет**.

**Могут ли эти настройки сами по себе приводить к молчанию?**

- Нет: target_chat задан, окна не сужают интервал, лимит 30 ответов в день не нулевой, inactivity не используется. Прямой причины «никогда не планировать» или «никогда не сканировать» в настройках нет. Косвенная причина молчания — **user_reply_max_age_minutes=30** в сочетании с тем, что момент фактической обработки due-ответов часто наступает позже, чем через 30 минут после сообщения пользователя (см. раздел 3.3 и итог).

---

### 3.2. chat_state

Запрос:

```sql
SELECT pipeline_id, chat_id, last_seen_message_id, last_human_message_at,
       replies_today, replies_today_date, next_scan_at
FROM chat_state;
```

**Результат (единственная запись):**

| pipeline_id | chat_id        | last_seen_message_id | last_human_message_at   | replies_today | replies_today_date | next_scan_at            |
|-------------|----------------|----------------------|--------------------------|---------------|--------------------|--------------------------|
| 3           | @news_backstage| 265                  | 2026-02-11 10:08:06.000000 | 6             | 2026-02-10         | 2026-02-11 12:32:00.594168 |

**Интерпретация:**

- Запись **chat_state для нужного пайплайна и чата есть** (pipeline_id=3, chat_id=@news_backstage). Сервис уже заходил в этот чат и обновлял состояние.
- **last_seen_message_id = 265** — последнее просмотренное сообщение имеет id 265; следующие сканы будут запрашивать сообщения с id &gt; 265.
- **last_human_message_at = 2026-02-11 10:08:06** — последнее человеческое сообщение, которое видел сканер, в 10:08. Значит, новые сообщения в чате сервис действительно видит.
- **replies_today_date = 2026-02-10** при **replies_today = 6** — счётчик ответов за день привязан к 10 февраля; при смене даты на 11 февраля в коде выполняется сброс счётчика (`chat_state.replies_today = 0`, `replies_today_date = today`), так что лимит 30 ответов в день не исчерпан для новой даты.
- **next_scan_at = 2026-02-11 12:32:00** — следующий скан разрешён с этого момента. Если диагностика выполнялась до 12:32, сканы временно не выполнялись (только отправка due); после 12:32 сканы снова запускаются. «Залипания» на нереалистично далёком next_scan_at не видно.

**Вывод:** Состояние chat_state соответствует работающему сценарию: чат сканируется, сообщения людей фиксируются, лимит по дате не блокирует. Отсутствие ответов в чате не объясняется отсутствием или «залипанием» chat_state.

---

### 3.3. discussion_replies (только kind='user_reply')

Запрос:

```sql
SELECT id, pipeline_id, kind, chat_id, account_name, status, send_at, sent_at, cancelled_reason
FROM discussion_replies
WHERE kind = 'user_reply'
ORDER BY id DESC
LIMIT 50;
```

**Результат:**

| id  | pipeline_id | kind      | chat_id        | account_name  | status    | send_at              | sent_at | cancelled_reason |
|-----|-------------|-----------|----------------|---------------|-----------|----------------------|---------|------------------|
| 54  | 3           | user_reply| @news_backstage| t9876002641   | cancelled | 2026-02-10 12:43:03  | NULL    | message too old  |
| 48  | 3           | user_reply| @news_backstage| t9876002641   | cancelled | 2026-02-10 09:38:06  | NULL    | message too old  |
| 46  | 3           | user_reply| @news_backstage| t9876002641   | cancelled | 2026-02-10 08:52:21  | NULL    | message too old  |
| 45  | 3           | user_reply| @news_backstage| t9083516765   | cancelled | 2026-02-10 08:41:21  | NULL    | message too old  |
| 44  | 3           | user_reply| @news_backstage| t9174800805   | cancelled | 2026-02-10 08:40:41  | NULL    | message too old  |
| 41  | 3           | user_reply| @news_backstage| t9014429801   | cancelled | 2026-02-10 08:08:21  | NULL    | message too old  |

**Интерпретация:**

- Записи с **kind='user_reply'** **есть** — значит, этап планирования Pipeline 2 срабатывает: кандидаты находятся, проверки до OpenAI проходят, вызов `generate_user_reply` выполняется, записи в `discussion_replies` создаются.
- **Все 6 записей в статусе cancelled** с причиной **`message too old`**. Ни одной успешной отправки (sent_at везде NULL).

Логика отмены в коде (`scheduler.py`, ~1819–1836): при обработке due-ответа считается возраст исходного сообщения от `source_message_at` (или от `send_at`, если source не задан). Если возраст в минутах больше `user_reply_max_age_minutes` (30), запись отменяется с причиной `"message too old"`.

Отсюда вывод: **ответы планируются на 2–10 минут после сообщения пользователя, но к моменту, когда сервис реально доходит до отправки этих записей, исходное сообщение уже старше 30 минут.** Возможные причины на данной инстанции:

- Сервис подолгу не запущен или перезапускается — накопившиеся due-ответы обрабатываются спустя долгое время после сообщения.
- Большая задержка между циклами или долгое выполнение других пайплайнов — очередь due по Pipeline 2 обрабатывается с опозданием.
- Часовой пояс/хранение времени: если где-то путаница UTC/локальное время, «сейчас» может сравниваться некорректно с `source_message_at`, но при одинаковой системе хранения это менее вероятно, чем просто запаздывание обработки.

Итого: на этапе планирования и создания записей Pipeline 2 **не молчит**; молчание в чате вызвано тем, что **все запланированные ответы отменяются при попытке отправки** из-за превышения допустимого возраста сообщения (30 минут).

---

## 4. Логи Pipeline 2 (фактическое поведение)

Проверка логов в каталоге `/home/tg_post_service/logs/`:

- Каталог существует, но **файлов в нём не обнаружено** (или в нём нет логов сервиса).
- Поиск по содержимому (grep по вариантам "user reply", "user_reply", "live", "candidate", "pipeline2") **не дал ни одной строки**.

**Вывод:** По текущим логам нельзя подтвердить или уточнить поведение Pipeline 2 (частоту сканов, число кандидатов, причины skip/cancel, успешные отправки). Выводы о причинах молчания сделаны на основе **состояния БД** и **кода**: наличие записей user_reply и единая причина отмены `message too old` однозначно указывают на отмену при отправке из-за возраста сообщения.

Если в следующих запусках логи появятся, имеет смысл смотреть:

- «user reply skipped: …» — на каком условии отсекаются кандидаты (probability, message too old, inactive chat, no available userbots и т.д.).
- «user reply scheduled» / «user reply sent» / «user reply cancelled» — подтверждение планирования и причин отмены (в т.ч. «message too old»).

---

## 5. OpenAI в контексте Pipeline 2 (runtime)

- В `project_root/openai_client.py` функция `generate_user_reply` вызывается из `scheduler.py` в `_plan_user_reply_for_candidate` (при выборе бота и генерации текста ответа).
- Наличие записей в `discussion_replies` с `kind='user_reply'` означает, что **до вызова OpenAI доходит** хотя бы часть кандидатов и что генерация для выбранных ботов завершается без исключения (иначе запись не создаётся — см. `continue` после `logger.exception("user reply skipped: openai error")`).
- В логах проверить ошибки OpenAI не удалось (логов нет). По БД признаков того, что молчание вызвано сбоями или таймаутами OpenAI, нет: записи создаются, отменяются позже по правилу «message too old».

**Вывод:** Нет оснований считать, что Pipeline 2 молчит из-за ошибок OpenAI; отмена по возрасту сообщения происходит уже после успешной генерации текста.

---

## 6. Итог: вероятная причина, почему Pipeline 2 сейчас молчит

1. **Ответы создаются, но все отменяются при отправке по причине «message too old».**  
   В БД есть 6 записей `discussion_replies` с `kind='user_reply'`, все со статусом `cancelled` и `cancelled_reason = 'message too old'`. Код в `_send_due_user_replies` (`scheduler.py`, проверка возраста от `source_message_at` против `user_reply_max_age_minutes`) отменяет запись, если с момента исходного сообщения прошло больше 30 минут. То есть к моменту обработки очереди due ответов сообщение пользователя уже считается устаревшим.

2. **Почему к моменту отправки сообщение оказывается старше 30 минут.**  
   Запланированное время отправки — через 2–10 минут после сообщения (плюс 3–15 минут для второго бота). При нормальной частоте цикла (30–60 сек при наличии DISCUSSION) ответ теоретически мог бы уйти вовремя. Фактически же все найденные ответы были отменены. Это согласуется с тем, что либо сервис часто не работает в нужное время (остановки, перезапуски), либо один цикл планировщика выполняется настолько долго, что к моменту вызова `_send_due_user_replies` для пайплайна 3 проходит больше 30 минут с момента сообщения. Таким образом, ограничение **user_reply_max_age_minutes=30** в сочетании с **реальным временем обработки** и приводит к молчанию в чате.

3. **Остальные элементы конфигурации и состояния не блокируют Pipeline 2.**  
   target_chat задан, chat_state для чата есть, last_human_message_at обновлён, окна активности не заданы, inactivity_pause=0, лимит ответов в день не исчерпан для текущей даты. Кандидаты находятся (иначе записей user_reply не было бы), до OpenAI доходит, записи создаются. Блокировка именно на этапе отправки.

4. **Привязка к коду и БД.**  
   - Проверка возраста: `scheduler.py`, в `_send_due_user_replies`, условие `age > settings.user_reply_max_age_minutes` и вызов `mark_discussion_reply_cancelled(session, reply, "message too old")`.  
   - Настройка: таблица `discussion_settings`, поле `user_reply_max_age_minutes = 30` для pipeline_id=3.  
   - Данные: все отменённые записи в `discussion_replies` с `kind='user_reply'` имеют `cancelled_reason = 'message too old'`.

---

## 7. Что можно будет поменять на следующем шаге (без реализации сейчас)

Ниже — только варианты изменений для последующего промпта; в коде и конфиге ничего не менялось.

- **Увеличить user_reply_max_age_minutes** (например до 45–60 или выше) в настройках DISCUSSION-пайплайна, чтобы запланированные ответы реже отменялись из-за возраста сообщения при запаздывании обработки.
- **Уменьшить задержку планирования** (сейчас 2–10 минут до первой отправки): сузить диапазон в коде (`first_send_at = base_time + timedelta(minutes=random.randint(2, 10))`), чтобы ответы попадали в окно 30 минут даже при редких или тяжёлых циклах.
- **Гарантировать обработку due-ответов до проверки возраста:** например, в начале цикла сначала обрабатывать все due user_reply по всем DISCUSSION-пайплайнам (или ставить Pipeline 2 в приоритет), а уже потом выполнять тяжёлые задачи (сканы, Pipeline 1, постинг), чтобы время между `send_at` и фактической отправкой не раздувалось.
- **Добавить логирование** при отмене по «message too old» (уже есть `logger.info("user reply cancelled: message too old")`; при необходимости логировать также `reply.id`, `age`, `source_message_at`, `send_at`) и при планировании (кандидат, выбранный бот, `send_at`, `source_message_at`) — для последующей точечной настройки лимитов и задержек.
- **Опционально ослабить фильтр кандидатов** (`_is_candidate_for_reply`): добавить триггерные фразы или разрешить ответы на любые сообщения при определённых условиях — если цель увеличить число планируемых ответов; на текущее молчание это не влияет, т.к. планирование уже происходит.
- **Проверить расписание и нагрузку:** при длительных простоях сервиса или очень редком цикле рассмотреть увеличение частоты цикла для DISCUSSION или вынос отправки due-ответов в отдельный быстрый шаг.

---

*Диагностика выполнена только чтением БД и кода; код, БД, конфигурация и логи не изменялись.*
