Возьми промпт для изменения характера любого юзербота.
Ничего не изменяй.
Выведи текущее состояние персоны юзербота АСС1.
Нужен только отчёт в формате "было".


Возьми промпт для изменения характера любого юзербота.
Ничего не изменяй.
Выведи текущее состояние ИЗ БД ВСЕХ персон юзерботОВ В ПОРЯДКЕ ДОБАВЛЕНИЯ ИХ В БД


ЗАТЕМ ИЗМЕНИ ХАРАКТЕР ЮЗЕРБОТА АСС1 НА
persona_tone: skeptical
persona_verbosity: short
persona_style_hint: Не пересказывает пост. Сразу вычленяет спорное допущение или слабый тезис и задаёт точечный вопрос, который делит аудиторию. Может задать 1–2 коротких вопроса подряд.
persona_topics: ["политика", "общество", "медиа", "экономика"]
persona_topic_priority: 80
persona_offtopic_tolerance: 20


По инструкции "промпт для изменения характера любого юзербота":
покажи текущий характер юзербота t9174803110 без внесения изменений.

=============================
Возьми промпт для изменения характера любого юзербота.
ИЗМЕНИ ПЕРЕПИШИ ЗНАЧЕНИЯ ПОЛЕЙ В БД персоны юзербота АСС1 НА СЛЕДУЮЩИЕ ЗНАЧЕНИЯ


=============================


source venv/bin/activate


sqlite3 tg_post_service.db "SELECT account_name FROM discussion_bot_weights WHERE pipeline_id = (SELECT id FROM pipelines WHERE name = 'discuss_news_blackbox') ORDER BY id;"







# Промпт для изменения характера любого юзербота

Этот документ — единая инструкция для AI: как каждый раз изменять «характер» (персону) юзербота через таблицу `userbot_persona` в БД. При запросе вида *«возьми промпт для изменения характера любого юзербота и измени характер юзербота &lt;ИМЯ&gt; вот по этому описанию: &lt;ТЕКСТ&gt;»* — открыть этот файл и действовать по нему.

---

## 2.1. Входные данные

Что ожидается от пользователя при каждом запросе:

### Обязательное

1. **Идентификатор юзербота** — один из двух вариантов:
   - **account_name** из таблицы `userbot_persona` (например: `t9174800805`, `acc1`);
   - **человекочитаемое имя**, если в проекте есть однозначное соответствие (например «Дмитрий Орлов»), и по коду/БД можно сопоставить его с `account_name`.

2. **Новый «промпт характера»** в свободной форме — русский текст с описанием персоны (как ранее для t9174800805).

### Опционально (если пользователь задаёт явно)

- **persona_tone** — желаемый тон: `neutral` / `analytical` / `skeptical` / `emotional` / `ironic`.
- **persona_verbosity** — желаемая краткость: `short` / `medium`.
- **Список интересов (тем)** в свободной форме (например: «финансы, рынки, золото, макроэкономика»).

### Поведение по умолчанию

- **persona_tone** и **persona_verbosity**: если пользователь их **не указал явно** — вывожу их из смысла описания характера.
- **Интересы (persona_topics)**: по умолчанию **не трогаю**, если пользователь отдельно не попросил «измени интересы» и не дал подсказку.

---

## 2.2. Поиск нужного юзербота

Алгоритм поиска записи:

1. Открываю код проекта и/или смотрю таблицу `userbot_persona` (модель в `project_root/models.py`, работа через `project_root/db.py`: `get_userbot_persona(session, account_name)`).

2. Если пользователь дал **account_name** (строка вида `t9...`, `acc1`, `acc2`) — ищу запись по полю `account_name`.

3. Если пользователь дал **человекочитаемое имя** (например «Дмитрий Орлов») и в проекте уже есть логика сопоставления «имя → account_name» — использую её.

4. **Если однозначно сопоставить имя с account_name нельзя** — обязательно задаю уточняющий вопрос и **не вношу изменений**, пока не получу точный идентификатор аккаунта.

> **Правило:** Если я не могу однозначно сопоставить имя к `account_name` — я задаю уточняющий вопрос и не вношу изменений, пока не получу точное имя аккаунта.

---

## 2.3. Чтение текущего состояния (БД)

Перед изменением:

1. Через ORM (или SQL) читаю строку из `userbot_persona` по выбранному `account_name`.

2. Забираю текущие значения полей:
   - `persona_tone`
   - `persona_verbosity`
   - `persona_style_hint`
   - `persona_topics`
   - `persona_topic_priority`
   - `persona_offtopic_tolerance`

3. **Все** эти значения сохраняю для отчёта «до» (before), чтобы потом вывести дифф.

### Если записи нет

- Явно фиксирую в ответе: *«userbot с таким account_name не найден»*.
- **Ничего не создаю автоматически**, пока пользователь отдельно не попросит: «создай новую запись для этого userbot’а».

---

## 2.4. Как из текста вытащить новые поля

Правила маппинга свободного описания персонажа в поля таблицы:

### 1) persona_style_hint

- Всегда записываю туда текст описания характера от пользователя (или слегка отредактированную версию для аккуратного вида).
- Можно немного структурировать, но без потери смысла.

### 2) persona_tone

- Вывожу из ключевых слов и общего смысла:
  - «спокойный», «аналитика», «структурирует», «без эмоций» → **analytical**
  - «сомневается», «вторая сторона», «ставит под вопрос» → **skeptical**
  - «ирония», «шуточки», «подколы» (без жести) → **ironic**
  - «эмоционально реагирует», «делится эмоциями» → **emotional**
  - ничего специфичного → **neutral**
- Если пользователь **явно** написал «тон: skeptical» / «neutral» / и т.д. — использую это, а не свои догадки.

### 3) persona_verbosity

- «коротко», «чатит в 1–2 предложения», «без воды» → **short**
- «может развёрнуто объяснять», «2–4 предложения», «иногда длиннее» → **medium**
- По умолчанию при отсутствии явных указаний — **short**.

### 4) persona_topics (интересы)

- Если в описании **явно перечислены** темы (например: «интересуется криптой, геополитикой, технологическими акциями») — выделяю их в список строк.
- Сохраняю в `persona_topics` как **JSON-список строк** (в БД поле типа Text, в коде используется `json.dumps(list)` / парсинг через `json.loads`).
- Если про интересы ничего нет — оставляю существующее поле **без изменений**.

### 5) persona_topic_priority / persona_offtopic_tolerance

- Если пользователь **ничего не сказал** про «насколько сильно привязан к теме» — оставляю текущие значения **как есть**.
- Если прямо сказал «сильно тянет к этой теме» — могу слегка повысить `persona_topic_priority` (например с 50 до 70).
- Если сказал «может легко уходить в оффтоп» — могу увеличить `persona_offtopic_tolerance` (например с 50 до 70).
- **По умолчанию эти числа не трогаются** без явного запроса со стороны пользователя.

---

## 2.5. Обновление БД

Стандартная последовательность:

1. Формирую новые значения полей (`new_*`), **не трогая**:
   - `account_name`;
   - `persona_topics`, `persona_topic_priority`, `persona_offtopic_tolerance` — если пользователь явно не запросил их обновление.

2. Если новые значения `persona_tone` / `persona_verbosity` / `persona_style_hint` **совпадают** с тем, что уже в БД:
   - **ничего не обновляю**;
   - в ответе честно пишу: *«данные уже соответствуют новому описанию, изменений не вносил»*.

3. Если есть реальные изменения:
   - выполняю UPDATE через ORM (например присвоение полей объекту и `session.commit()` в `project_root/db.py` или через существующие хелперы);
   - делаю commit.

---

## 2.6. Отчёт «было → стало»

Формат отчёта после операции (всегда вывожу):

1. **Кратко:**  
   *«Обновлена персона для account_name = &lt;имя&gt;»*  
   (или сообщение о том, что изменений не было / запись не найдена).

2. **Блок «Было»:**
   - persona_tone: &lt;старое&gt;
   - persona_verbosity: &lt;старое&gt;
   - persona_style_hint: &lt;старое&gt; (можно обрезать, если очень длинный, но предпочтительно показать полностью)
   - persona_topics: &lt;старое значение&gt;
   - persona_topic_priority: &lt;старое&gt;
   - persona_offtopic_tolerance: &lt;старое&gt;

3. **Блок «Стало»:**
   - те же поля с новыми значениями.

4. Если какие-то поля сознательно **не менялись** (например topics / priority / tolerance) — явно подписываю:  
   *«persona_topics / persona_topic_priority / persona_offtopic_tolerance оставлены без изменений»*.

---

## 2.7. Безопасные ограничения

Правила безопасности, зафиксированные в инструкции:

1. **Никогда не изменять** без прямого запроса пользователя:
   - структуру таблицы `userbot_persona`;
   - логику пайплайнов (Pipeline 1 / Pipeline 2);
   - системный промпт;
   - настройки OpenAI.

2. Любые изменения — **только в одной записи** `userbot_persona` по **одному** `account_name` за один запрос.

3. Если что-то непонятно:
   - задаю уточняющий вопрос;
   - не делаю догадок по критичным вещам (например, не создаю новую запись с «левым» account_name без явной просьбы).
