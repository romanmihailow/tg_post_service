# Пайплайн 2 — изменения конфигурации (v1)

## Что изменено

Для DISCUSSION-пайплайна **discuss_news_blackbox** (pipeline_id=3) значение **user_reply_max_age_minutes** при инициализации/обновлении настроек поднято с **30** до **120** минут.

Остальные DISCUSSION-пайплайны по-прежнему используют значение из конфигурации (`discussion_user_reply_max_age_minutes` в `PipelineConfig`, по умолчанию 30). Окна активности, inactivity, лимиты в день, задержки отправки, вероятности и прочая логика Pipeline 2 не менялись.

---

## Где это настраивается

- **Файл:** `project_root/db.py`
- **Функция:** `_ensure_pipelines`
- **Место:** вызов `upsert_discussion_settings(...)` для пайплайнов с `pipeline_type == "DISCUSSION"`. Аргумент `user_reply_max_age_minutes` задаётся так:
  - если `pipeline_config.name == "discuss_news_blackbox"` — передаётся **120**;
  - иначе — `pipeline_config.discussion_user_reply_max_age_minutes` (из конфига/JSON, по умолчанию 30).

Имя пайплайна берётся из конфигурации (например из `PIPELINES_JSON`), модель `PipelineConfig` в `project_root/config.py` по-прежнему имеет поле `discussion_user_reply_max_age_minutes: int = 30`; для discuss_news_blackbox это значение при инициализации переопределяется только в `db.py`.

---

## Как это влияет на поведение

Запланированные ответы Pipeline 2 перестанут массово отменяться с причиной **message too old**, если сервис временно не успел обработать due-очередь в течение первых 30 минут. Теперь у исходного сообщения пользователя есть до **120 минут**, чтобы ответ успел уйти (проверка возраста при отправке в `_send_due_user_replies` использует `settings.user_reply_max_age_minutes` из БД). Остальные проверки (inactivity, окна активности, лимиты ботов и т.д.) не менялись.

---

## Как проверить

1. **Убедиться, что в БД для пайплайна 3 стоит 120:**

   ```sql
   SELECT pipeline_id, target_chat, user_reply_max_age_minutes
   FROM discussion_settings
   WHERE pipeline_id = 3;
   ```

   Ожидается: `user_reply_max_age_minutes = 120`. (После перезапуска сервиса при следующем вызове `init_db` / `_ensure_pipelines` значение обновится.)

2. **Проверка в реальном чате:** написать в @news_backstage сообщение с «?» или одной из триггерных фраз (например «как думаете»). Дождаться 2–10 минут (планируемая задержка первого ответа). Убедиться, что сервис запущен и цикл планировщика выполняется. Если ответ пришёл в чат — Pipeline 2 доставляет сообщения; если в логах есть «user reply sent» — отправка прошла без отмены по возрасту. Если ответ не пришёл, проверить логи на «user reply cancelled: message too old» (при новом лимите 120 такое отмены должны быть реже, если обработка due происходит в пределах двух часов после сообщения).
